name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

env:
  SCHEME: DataBar
  PRODUCT_NAME: DataBar

jobs:
  build-and-release:
    name: Build, Sign, Notarize and Release
    runs-on: macos-latest
    env:
      APPLE_DEVELOPER_ID_APPLICATION_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
      APPLE_DEVELOPER_ID_APPLICATION_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
      APPLE_DEVELOPER_KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
      APPLE_API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
      APPLE_API_ISSUER_ID: ${{ secrets.APPLE_API_ISSUER_ID }}
      APPLE_API_KEY_BASE64: ${{ secrets.APPLE_API_KEY_BASE64 }}
      KEYCHAIN_FILE: "apple-developer.keychain-db"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version $VERSION"

      - name: Install Apple Developer ID Certificate
        run: |
          CERTIFICATE_PATH="$RUNNER_TEMP/certificate.p12"
          echo -n "$APPLE_DEVELOPER_ID_APPLICATION_CERTIFICATE" | base64 --decode -o "$CERTIFICATE_PATH"
          
          security create-keychain -p "$APPLE_DEVELOPER_KEYCHAIN_PASSWORD" "$RUNNER_TEMP/$KEYCHAIN_FILE"
          security set-keychain-settings -lut 21600 "$RUNNER_TEMP/$KEYCHAIN_FILE"
          security unlock-keychain -p "$APPLE_DEVELOPER_KEYCHAIN_PASSWORD" "$RUNNER_TEMP/$KEYCHAIN_FILE"
          security import "$CERTIFICATE_PATH" -P "$APPLE_DEVELOPER_ID_APPLICATION_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k "$RUNNER_TEMP/$KEYCHAIN_FILE"
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$APPLE_DEVELOPER_KEYCHAIN_PASSWORD" "$RUNNER_TEMP/$KEYCHAIN_FILE"
          security list-keychain -d user -s "$RUNNER_TEMP/$KEYCHAIN_FILE"

      - name: Resolve Swift packages
        run: xcodebuild -resolvePackageDependencies -scheme $SCHEME

      - name: Update version in project
        run: |
          cd DataBar.xcodeproj
          sed -i '' "s/MARKETING_VERSION = .*/MARKETING_VERSION = ${{ steps.version.outputs.version }};/g" project.pbxproj
          sed -i '' "s/CURRENT_PROJECT_VERSION = .*/CURRENT_PROJECT_VERSION = ${{ github.run_number }};/g" project.pbxproj

      - name: Archive
        env:
          SIGNING_IDENTITY: ${{ secrets.CODE_SIGN_IDENTITY }}
          TEAM_ID: ${{ secrets.DEVELOPMENT_TEAM }}
        run: |
          xcodebuild -scheme "$SCHEME" \
            -configuration Release \
            -destination "platform=macOS" \
            -archivePath "$PRODUCT_NAME.xcarchive" \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="$SIGNING_IDENTITY" \
            DEVELOPMENT_TEAM="$TEAM_ID" \
            PROVISIONING_PROFILE_SPECIFIER="" \
            archive

      - name: Export
        run: |
          xcodebuild -exportArchive \
            -archivePath "$PRODUCT_NAME.xcarchive" \
            -exportPath Export \
            -exportOptionsPlist ExportOptions.plist

      - name: Notarize
        run: |
          ditto -c -k --keepParent "Export/$PRODUCT_NAME.app" "Export/$PRODUCT_NAME.zip"
          
          mkdir -p ~/.private_keys
          echo -n "$APPLE_API_KEY_BASE64" | base64 --decode > ~/.private_keys/AuthKey_${APPLE_API_KEY_ID}.p8
          
          xcrun notarytool submit "Export/$PRODUCT_NAME.zip" \
            --key ~/.private_keys/AuthKey_${APPLE_API_KEY_ID}.p8 \
            --key-id "$APPLE_API_KEY_ID" \
            --issuer "$APPLE_API_ISSUER_ID" \
            --wait
          
          xcrun stapler staple "Export/$PRODUCT_NAME.app"
          
          rm -rf ~/.private_keys

      - name: Create final zip
        run: |
          cd Export
          rm -f $PRODUCT_NAME.zip
          ditto -c -k --keepParent $PRODUCT_NAME.app $PRODUCT_NAME.zip

      - name: Sign update with Sparkle
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          cd Export
          
          curl -L -o sparkle.tar.xz https://github.com/sparkle-project/Sparkle/releases/download/2.6.4/Sparkle-2.6.4.tar.xz
          mkdir -p sparkle_tools
          tar -xf sparkle.tar.xz -C sparkle_tools
          
          echo "$SPARKLE_PRIVATE_KEY" > /tmp/sparkle_key
          SIGNATURE=$(sparkle_tools/bin/sign_update $PRODUCT_NAME.zip --ed-key-file /tmp/sparkle_key)
          rm /tmp/sparkle_key
          
          echo "SPARKLE_SIGNATURE<<EOF" >> $GITHUB_ENV
          echo "$SIGNATURE" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          FILE_SIZE=$(stat -f%z $PRODUCT_NAME.zip)
          echo "FILE_SIZE=$FILE_SIZE" >> $GITHUB_ENV

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: DataBar v${{ steps.version.outputs.version }}
          body: |
            ## DataBar v${{ steps.version.outputs.version }}
            
            ### Installation
            1. Download `DataBar.zip` below
            2. Unzip and move `DataBar.app` to your Applications folder
            3. Open the app (it's signed and notarized)
          files: Export/DataBar.zip
          draft: false
          prerelease: false

      - name: Update appcast.xml
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          DOWNLOAD_URL="https://github.com/sammarks/DataBar/releases/download/v${VERSION}/DataBar.zip"
          PUB_DATE=$(date -R)
          
          cat > appcast.xml << EOF
          <?xml version="1.0" encoding="utf-8"?>
          <rss version="2.0" xmlns:sparkle="http://www.andymatuschak.org/xml-namespaces/sparkle" xmlns:dc="http://purl.org/dc/elements/1.1/">
            <channel>
              <title>DataBar Updates</title>
              <link>https://github.com/sammarks/DataBar</link>
              <description>Most recent changes with links to updates.</description>
              <language>en</language>
              <item>
                <title>Version ${VERSION}</title>
                <pubDate>${PUB_DATE}</pubDate>
                <sparkle:version>${{ github.run_number }}</sparkle:version>
                <sparkle:shortVersionString>${VERSION}</sparkle:shortVersionString>
                <sparkle:minimumSystemVersion>13.1</sparkle:minimumSystemVersion>
                <enclosure
                  url="${DOWNLOAD_URL}"
                  length="${FILE_SIZE}"
                  type="application/octet-stream"
                  ${SPARKLE_SIGNATURE}
                />
              </item>
            </channel>
          </rss>
          EOF

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin main
          git checkout main
          git add appcast.xml
          git commit -m "Update appcast.xml for v${VERSION}"
          git push origin main

      - name: Clean up keychain
        if: always()
        run: security delete-keychain "$RUNNER_TEMP/$KEYCHAIN_FILE" || true
